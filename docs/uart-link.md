# MCU↔MCU 串口通信方案（硬件 + 软件）

范围
- 适用对象：STM32G431（`firmware/eload-core`）与 ESP32‑S3（`firmware/host-bridge`）之间的板间链路。
- 本文仅聚焦“通信方案（硬件+软件）”，不展开其他备选总线/器件对比。

目标
- 简单可靠、易调试，满足实时控制与 50–100 Hz 遥测。
- 消息可演进（版本/向后兼容），链路异常时有安全兜底。

一、硬件链路（来自仓库现有文档 + 确认信息）
- 物理接口：UART（仓库现有说明明确 MCU ↔ ESP 默认 UART）。
- 逻辑电平：3.3 V，8N1（最终以原理图为准）。
- 数字隔离器（已确认）：TI ISO7721DR（8‑pin SOIC‑D，默认输出高）
  - 通道方向：1 发 / 1 收；建议映射：`S3_TXD → ISO_INA/OUTA → G431_RXD`，`G431_TXD → ISO_INB/OUTB → S3_RXD`。
  - 供电：隔离两侧各自 3.3 V（器件支持 2.25–5.5 V）。
  - 关键指标（摘自数据手册）：数据率至 100 Mbps，典型 tPD≈11 ns，CMTI 典型 ±100 kV/µs，D 封装 UL1577 3 kVrms。
- 走线与防护：
  - 板间连接器走线短、低阻；TX 串 22–47 Ω 抑制振铃；接口侧布置 TVS/ESD。
  - 隔离器紧邻连接器，保持隔离缝隙处爬电/电气间隙满足封装要求。
- 电源与时序：
  - 电源树：12 V（风扇）、5 V（逻辑/USB）、3.3 V（MCU/ESP）。
  - 上电顺序：先 3.3 V，再使能模拟前端；隔离两侧各自就近去耦。

二、软件协议（帧格式 + 消息集）
- 帧封装：遵循仓库 README 建议采用“CBOR/SLIP”。推荐实现：
  - SLIP 作为帧边界（0xC0 分隔、0xDB 转义）。
  - 载荷使用 CBOR 编码（小端数值约定）。
  - 在 CBOR 末尾附加 CRC‑16/CCITT‑FALSE（poly 0x1021, init 0xFFFF）作整帧校验。

- 帧头（建议，便于版本与可靠性）
  - `ver:u8` 协议主版本（初始 0x01）。
  - `flags:u8` 位0=ACK_REQ，位1=IS_ACK，位2=IS_NACK，位3=IS_RESP。
  - `seq:u8` 包序号（0..255 回绕）。
  - `msg:u8` 消息 ID（见下）。
  - `len:u16LE` 负载字节数。

- 可靠性
  - 控制/配置帧默认置位 ACK_REQ；对端用 ACK/NACK 回应（回显 `seq`/`msg`）。
  - 遥测帧默认无需 ACK（50–100 Hz）；需要时可临时打开 ACK 诊断。
  - 超时/出错重试：建议 3 次退避（如 5/10/20 ms）。
  - 心跳/看门狗：空闲心跳 10 Hz；>300 ms 无有效帧标记降级，主控侧可触发安全失能。

- 消息集合（初版建议）
  - 0x01 Hello（G431→S3，上电一次：协议/固件信息）
  - 0x02 Ping（双向：保活/测延时）
  - 0x03 Ack / 0x04 Nack（确认/拒绝）
  - 0x10 Status（G431→S3 周期遥测：时间戳、电压mV、电流mA、功率mW、温度mdegC、模式、使能、故障标志）
  - 0x11 Fault（G431→S3 事件：故障标志/是否锁存）
  - 0x20 SetEnable（S3→G431：使能/失能）
  - 0x21 SetMode（S3→G431：模式 CC/CV/CP/CR）
  - 0x22 SetPoint（S3→G431：设定值 + 单位，如 mA/mV/mW/mΩ）
  - 0x23 SetLimits（S3→G431：电流/功率/电压上下限）
  - 0x24 GetStatus（S3→G431：请求立即返回 Status）
  - 0x30 CalRead / 0x31 CalWrite（标定数据读写，按需启用）

- 角色
  - ESP32‑S3：主控（UI/日志/标定/桥接），下发控制命令，轮询/订阅遥测。
  - STM32G431：实时控制与保护（独立安全），周期上报遥测/故障，关键故障本地强制失能。

- 波特率与节拍（建议）
  - 波特率：460800–1M（结合布线与时钟抖动评估，最终以硬件定型为准）。
  - 遥测：空闲 10 Hz，工作 50–100 Hz；控制命令实时响应。

三、联调步骤（最小可用）
- 上电：G431 发送 Hello → S3 回 Ack；随后 G431 周期发 Status（10 Hz）。
- 设定：S3 下发 SetEnable/SetPoint（带 ACK_REQ），G431 回 Ack 并在后续 Status 中反映变更。
- 故障：注入温度/电压等异常 → G431 立即发 Fault 并本地失能；S3 呈现状态。

四、落地建议（代码结构）
- 共享库（`libs/`）：定义消息 ID、CBOR 结构体、SLIP 与 CRC 工具、无分配缓冲。
- G431：USART + DMA 接收环形缓冲，任务解析帧并投递到控制环。
- S3：UART 接收空闲超时分帧，任务管理重传/心跳与上层 UI/记录。

五、待确认项（跨硬件文档）
- 双端 UART 实例与引脚映射、连接器引脚定义。
- 数字隔离器：ISO7721DR 已确认；请在原理图标注通道方向与复位默认态（与 UART idle‑high 一致）。
- 波特率回退策略、错误计数阈值、降级/失能策略。
