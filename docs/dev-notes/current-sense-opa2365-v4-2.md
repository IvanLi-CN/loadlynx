# 恒流通道电流采样方案（v4.2，基于 OPA2365AIDR）

目标：在 v4.2 硬件中，用单颗 OPA2365AIDR（双路运放）完成两个负载通道的电流采样，输出电压同时供 MCU ADC 采样和 MOSFET 驱动电路的反相输入使用，替代 v4.1 中基于 INA193 的电流监测链路。

## 1. 设计约束与现状

- 每通道额定电流：5 A；建议设计量程：0–6 A（保留一定过载余量）。两通道并联工作时，总电流目标约 10 A（每通道 ≤5 A）。
- 运放电源：3.3 V（与 MCU 模拟电源同轨，参考 `VDDA`）。
- v4.1 现有分流电阻：R20/R34 为 25 mΩ、3 W（`RLP25FEGR025`，2512 封装），串在 `VLOAD_N` 与 MOSFET 源极之间，且通过 R90（0 Ω，1206）把 `VLOAD_N` 与 GND 等电（低侧采样结构）。
- v4.2 计划：将 R20/R34 调整为 50 mΩ/3 W，同一封装与版位，仅修改阻值，以换取更好的低电流分辨率。
- v4.1 使用 INA193（U2/U6）做高侧电流检测，输出网络为：
  - CH1：U2（`INA193AIDBVR`）→ `CUR1_SP` → R17（1 kΩ）、C14（47 nF）、C13（100 nF）、R18（100 kΩ，可选）、R27（100 Ω）等 RC 过滤和缓冲后送往 MCU / 控制环路。
  - CH2：U6 → `CUR2_SP` → R30（1 kΩ）、C25（47 nF）、C24（100 nF）、R31（100 kΩ，可选）、R27（100 Ω）等类似网络。

v4.2 中，计划完全移除 INA193（U2/U6）及其专用 RC 网络，改为 OPA2365 直接从 50 mΩ 分流电阻做低侧精确放大。

## 2. 分流电阻选型与功耗评估

v4.1 中选择 25 mΩ 更多是受 INA193 固定增益 20 V/V 约束；在改用 OPA2365 后，Rsense 与增益可以重新联合优化。这里明确采用 **50 mΩ/3 W** 作为 v4.2 的目标配置。

- 50 mΩ：
  - 5 A 时压降：`Vsh = 5 A × 50 mΩ = 250 mV`，功耗约 `P ≈ 1.25 W`。
  - 6 A 时压降：`Vsh = 6 A × 50 mΩ = 300 mV`，功耗约 `P ≈ 1.8 W`。
  - 相对 v4.1 的 25 mΩ，在相同电流下压降和功耗翻倍，但在 3 W 额定功率下仍有充足余量，且 0.25–0.3 V 相对几十伏输入可接受。
  - 小电流段信号幅度翻倍，有利于提高 50 mA 起步电流附近的分辨率与相对精度。

总结：

- v4.2 推荐将 R20/R34 更改为 **50 mΩ/3 W 合金电阻**（保持 2512 封装与焊盘不变）；
- 在 0–6 A 范围内，配合 OPA2365 的低失调（典型 100–200 µV）和合适的放大倍数，可以在不牺牲高端裕量的前提下，把单通道的可用测量范围稳定做到 50 mA 起步；
- 双通道并联工作时，总电流目标 10 A（每通道 ≤5 A），此时每个 Rsense 上的功耗与压降仍在上述区间。

## 3. 单通道电路拓扑与增益设计

### 3.1 拓扑概述（单通道）

- 分流电阻：`Rsense = 50 mΩ`，Kelvin 接法，靠近 MOSFET 源极与 `VLOAD_N` 之间。
- 采样方式：低侧、单端采样。
  - 分流电阻靠 GND 端为系统地（通过 0 Ω 电阻 R90 与 GND 等电）。
  - 运放输入直接在分流电阻上取单端电压：`Vshunt = Vsense = V(上端) − GND`。
- 运放配置：OPA2365 单通道工作在**同相放大器**模式：

  - `+IN` 接分流电阻上端（Kelvin 点）；
  - `-IN` 端由 `Rf`（反馈电阻）和 `Rg`（到 GND 的电阻）构成反馈网络；
  - 输出 `Vout` 为放大后的电流采样电压，同时送往 MCU ADC 与 MOSFET 驱动负反馈输入（中间通过 100 Ω 隔离电阻）。

电压关系：

```text
Vout = (1 + Rf / Rg) · Vshunt
Iload ≈ Vshunt / Rsense = Vout / [(1 + Rf / Rg) · Rsense]
```

### 3.2 推荐增益与电阻值

设计目标：**额定量程 0–5 A**，并在 5 A 以上保留一定硬件余量（约 5.5–5.8 A），ADC 有效量程 0–2.9 V，保证单通道在 50 mA 附近仍有可观的输出电压。

- 取额定满量程点：`I_FS,rated = 5 A`。
- 对应分流电阻电压：`Vsh_FS,rated = 5 A × 50 mΩ = 250 mV`。
- 目标额定满量程输出：`Vout_FS,rated ≈ 2.5 V`（留出约 0.4 V 供 >5 A 短时余量，2.9 V 对应约 5.8 A）。
- 需要的电压增益：

```text
G = Vout_FS,rated / Vsh_FS,rated ≈ 2.5 V / 0.250 V = 10
```

选用 E24 系列电阻：

- `Rg = 3.0 kΩ`
- `Rf = 27 kΩ`

则：

```text
G = 1 + 27k / 3k = 1 + 9 = 10

Vout (5 A) ≈ 10 × 0.250 V ≈ 2.5 V
Vout (5.8 A) ≈ 10 × (5.8 A × 50 mΩ) ≈ 2.9 V
Vout (0.05 A) ≈ 10 × (0.05 A × 50 mΩ) = 10 × 2.5 mV ≈ 25 mV
```

在 3.3 V 供电下，OPA2365 输出典型可逼近正轨 10–20 mV，本配置在 5 A 额定点输出约 2.5 V，2.9 V 对应约 5.8 A，提供了有限的硬件余量；超过约 5.8 A 时 ADC 将逐步进入饱和区。  
50 mA 附近输出 ≈25 mV，显著高于零点偏置和噪声水平，配合一次零点标定后可以视为单通道“可用起步点”；双通道并联时总体约 10 A 额定仍由每通道 5 A 限制决定。

### 3.3 频率响应与补偿

OPA2365 的 GBW ≈ 50 MHz，在增益 10 下，理论闭环带宽约 5 MHz。为了降低噪声并提高相位裕度，建议在反馈电阻两端并联小电容 `Cf`：

- `Cf ≈ 10–12 pF`（C0G，0402）。
- 截止频率：

```text
fc ≈ 1 / (2π · Rf · Cf)
   ≈ 1 / (2π · 27k · 12 pF)
   ≈ 490 kHz
```

该带宽远高于预期电流环路与采样带宽（一般不超过数十 kHz），同时能有效抑制高频噪声和开关干扰。

## 4. 与 MCU ADC 与 MOSFET 驱动的接口

### 4.1 输出节点与 100 Ω 串联电阻

每个 OPA2365 通道的输出节点定义为：

- CH1：运放输出网 `I_SENSE_CH1`，经 100 Ω（R9）送往 ADC 网 `CUR1_SP`；
- CH2：运放输出网 `I_SENSE_CH2`，经 100 Ω（R62）送往 ADC 网 `CUR2_SP`。

从 OPA2365 输出到 `CURx_SP` 之间放置一颗 100 Ω 串联电阻（每通道一颗），再由 `CURx_SP` 向下游分支驱动两个负载：

- 一路：`CURx_SP` → MOSFET 驱动/电流环路的反相输入（现有原理图中，等价节点为 `$1N154426`/`$1N154901` 一类的 OPA 环路输入）。
- 一路：`CURx_SP` → MCU ADC 通道，并在 ADC 端就地加小电容到 GND 组成 RC 滤波（详见下节）。

保留 100 Ω 串联电阻的理由：

- 隔离 OPA2365 输出与后级电路的输入电容（MOSFET 驱动输入、ADC 采样保持电容等），改善回路稳定性；
- 在出现瞬态如 ESD、插拔负载或 ADC 采样尖峰电流时，限制冲击电流，保护运放输出级；
- 对 DC 精度影响极小（仅与输出负载电流相关，此处负载阻抗非常高）。

推荐的实现方式就是“每通道一颗 100 Ω 串联电阻 + 下游分支”，不需要为 ADC 和环路分别再各加一颗 100 Ω。原则是**保证 OPA2365 看到的总负载电容不超过数据手册推荐值**，并在 `I_SENSE_CHx` 之后根据需要分别配置 ADC 端与环路端的小电容或分压网络。

### 4.2 ADC 端 RC 滤波

建议在 MCU ADC 端使用简单的一阶 RC 低通滤波：

- 串联电阻：已由上述 100 Ω 提供；
- 对地电容：`C_ADC ≈ 4.7–10 nF`（X7R，0402）。

对应截止频率：

```text
fc ≈ 1 / (2π · 100 Ω · 10 nF) ≈ 160 kHz
```

该频宽对典型 ADC 采样率（几十 kS/s）足够，同时对高频噪声（开关瞬态、数字干扰）提供明显衰减。注意将 `C_ADC` 靠近 MCU 管脚放置，走线参考干净的模拟地。

若需要进一步压低带宽（例如希望电流采样在几十 kHz 内），可将 `C_ADC` 增加到 22 nF，对应截止约 72 kHz，但需评估 ADC 采样保持阶跃对 OPA 输出稳定性的影响。

## 5. 版图与器件选型注意事项

### 5.1 分流电阻与运放布线

- R20/R34 采用 Kelvin 接法：分别从靠近 MOSFET 源极的一端与靠近 `VLOAD_N` 的一端拉出单独采样线接入 OPA2365 的输入，不与大电流走线共用铜皮。
- OPA2365 贴近 Rsense 布置，采样走线尽量短并远离高 dv/dt 节点（MOSFET 栅极、开关节点等）。
- 模拟地（GND/`VLOAD_N`）在运放周围保持完整铜皮，使用**单点连接**方式与大电流回路相连，避免采样回路中出现电流环。

### 5.2 运放电源与去耦

- `V+`（高电位）接 3.3 V 模拟电源（`VDDA`），`V-` 接 GND。
- 每颗 OPA2365 旁边放置至少一颗 100 nF + 一颗 1 µF 去耦电容，靠近电源引脚放置，并直接回到本地 GND 铜皮。

### 5.3 精度与温度

- Rf/Rg 建议使用 1% 厚膜电阻即可（如对精度有更高要求，可使用 0.1% 薄膜），并在 BOM 中统一系列，降低温漂不匹配风险。
- 分流电阻为 50 mΩ/3 W 合金电阻（v4.2 目标），温度系数 50 ppm/°C，对 6 A 量程的相对误差贡献主要来自温度和自热，建议在固件标定中预留温度系数修正（可通过板载温度采样修正整体电流换算系数）。

## 6. 与 v4.1 网表的差异与改动清单（草案）

为避免出现“多余器件未删干净”的情况，下面列出与 v4.1 相比当前方案在原理图上的主要差异，供后续改图时参考（具体以后续提供的更新网表为准）。

1. 删除器件（不装）：
   - U2、U6：`INA193AIDBVR`（电流检测放大器，SOT-23-5）。
   - 若 v4.2 不再使用 INA193：可选择保留或删除原 CUR1_SP/CUR2_SP 补偿网络（R17/C14/C13/R18 与 R30/C25/C24/R31）。在当前网表中，这组网络作为恒流环路补偿继续存在，删除前需评估环路稳定性。

2. 新增器件与连接（建议）：
   - 新增一颗 OPA2365AIDR（例如标号 `U_CUR`），其两个通道分别对应 CH1/CH2 电流采样。
   - 每通道新增：
     - `Rf = 27 kΩ`（输出→`-IN`）、`Rg = 3.0 kΩ`（`-IN`→GND）、`Cf ≈ 10–12 pF`（并联在 Rf 两端）。
     - 输出节点 `I_SENSE_CHx` → 100 Ω → MOSFET 驱动反相输入；
     - 输出节点 `I_SENSE_CHx` → 100 Ω → MCU ADCx 输入，并在 ADC 端增加 `C_ADC ≈ 4.7–10 nF` 至 GND。
   - 分流电阻：将现有 R20 / R34 从 25 mΩ/3 W 更新为 50 mΩ/3 W，并重新拉出 Kelvin 采样线接入 OPA2365 的输入（保持封装与焊盘不变）。

3. 网络命名建议：
   - 用语义化网络名替换中间匿名节点，便于后续固件与文档同步，例如：
     - `I_SENSE_CH1` / `I_SENSE_CH2`：放大后的电流采样电压；
     - `ISENSE_SHUNT_CHx_P`、`ISENSE_SHUNT_CHx_N`：分流电阻两端 Kelvin 点。

---

后续你在原理图中按照上述思路完成改动并导出新的网表后，可以将更新后的 `analog-board-netlist.enet` 提给我，我可以再对照实际连接（包括 ADC 通道、MOSFET 驱动输入、OPA2365 管脚分配等）做一次细化评审，确认没有悬空网络和多余器件。 
