# Loadlynx 硬件 v4.2 设计备忘（相对于 v4.1）

本文用于跟踪从硬件 v4.1 演进到 v4.2 时，已经确认需要在原理图 / PCB 上修正的设计问题及预期改动方向。当前聚焦模拟板（功率板）相关的隔离 5V 供电与电流检测链路。

## 1. v4.1 已知问题总览

- 隔离 5V DC/DC 模块（U15，B0505S‑1WR3）次级输出引脚在 v4.1 中与器件数据手册不一致，需要在 v4.2 中订正。
- 电流检测放大器选型为 INA193（U2/U6），其输出与输入均非轨到轨，叠加 25 mΩ 分流电阻与器件自身偏置，导致低电流段（接近 0 A）存在明显、不可忽略的测量误差。

后续若发现新的硬件问题，应在本节追加条目，并在下文补充详细分析与 v4.2 的对应改动。

## 2. 隔离 5V 模块输出引脚接错（U15，B0505S‑1WR3）

### 2.1 现有设计（v4.1）

- 器件：U15，MORNSUN B0505S‑1WR3（5 V→5 V/1 W 隔离 DC/DC），参见 `docs/power/netlists/analog-board-netlist.enet:gge420`。
- 当前网表中的连接关系：
  - 引脚 1：`USB-`（上游 5 V 域地）。
  - 引脚 2：`PWR_5V`（上游 5 V 电源）。
  - 引脚 3：`5V`（隔离次级 5 V）。
  - 引脚 4：`GND`（隔离次级地）。
- 该模块为 4 引脚 SIP 封装，典型应用为“1/2 输入 + 3/4 输出”，但具体极性与视图方向需严格以 B_S‑1WR3 系列官方数据手册为准。

根据 v4.1 实物板及调试反馈，U15 的次级输出在 PCB 上的走线方向与数据手册标注不一致，属于引脚定义与封装/布局之间的对齐错误，而非简单的网络名拼写问题。

### 2.2 风险与影响

- 隔离域 +5 V 轨可能出现以下问题之一（取决于实际装配方向）：
  - 次级 5 V 轨无法正常建立，导致隔离域后级（如运放电源、隔离侧逻辑）掉电。
  - 输出极性反接或与错误的参考点相连，存在器件应力过大甚至损坏的风险。
  - 隔离域的参考地与系统其余部分以非预期方式短接，破坏隔离意图。
- 由于 B0505S‑1WR3 自身带有输出短路保护，问题在上电阶段可能表现为：
  - 模块进入保护/限流状态，隔离 5 V 轨电压显著低于标称值。
  - 整机在特定负载条件下出现间歇性掉电或噪声异常。

上述问题在 v4.1 中已经通过实测确认“存在输出引脚接错”这一事实，因此在 v4.2 版本中必须通过原理图与封装修订来根本消除。

### 2.3 v4.2 设计要求与修改方向

- 以 B_S‑1WR3 系列官方数据手册为唯一基准，重新核对并在原理图中明确标注：
  - 哪一侧为输入引脚组（`VIN+` / `VIN-`），哪一侧为输出引脚组（`+VO` / `0V`）。
  - 正确认定“上视图/下视图”（Top / Bottom view）的方向，避免再次发生因视图方向误解导致的翻转。
- 在原理图中统一使用函数性网络名，而非仅通过数字编号推断：
  - 例如显式标注 `U15.VIN+`→`PWR_5V`，`U15.VIN-`→`USB-`；
  - `U15.VO+`→隔离域 `5V_ISO`（或 `5V_A` 等），`U15.VO-`→隔离域 `GND_ISO`。
- 若现有封装库中 B0505S‑1WR3 的焊盘顺序与数据手册不一致，应采取以下二选一策略：
  - 新建一份经过校对的专用封装（推荐），并在 PCB 中替换；
  - 或者在确认安全的前提下仅针对该封装实例进行旋转/镜像处理，并在封装注释中明确记录“视图方向与数据手册关系”。
- 在布局阶段增加一项专门检查：
  - 将 U15 周围的输入/输出走线与数据手册中的示意图逐一对照（包括引脚号与相邻机械边界），在设计评审清单中单独列出“隔离 DC/DC 引脚方向已核对”一项。

### 2.4 验证建议

- 原理图级：
  - 使用网络表在 `docs/power/netlists/analog-board-netlist.enet` 中再次导出 U15 条目，确认引脚→网络的映射与设计意图一致。
- 板级验证：
  - 在 v4.2 PCB 中为隔离 5 V 轨预留测点（`TP_5V_ISO`、`TP_GND_ISO`），上电后直接在模块输出端测量电压与极性。
  - 记录模块工作时输入/输出端的电压波形与温升，以确认未进入限流或保护状态。

## 3. INA193 非轨到轨导致低电流测量误差

### 3.1 现有设计（v4.1）

- 器件：U2/U6，INA193AIDBVR（TI 高侧电流检测放大器），参见 `docs/power/netlists/analog-board-netlist.enet:gge40_1` 与 `gge40_2`。
- 相关网络与器件：
  - 分流电阻：R20/R34，`RLP25FEGR025`，阻值 25 mΩ、额定功率 3 W（见同一网表片段）。
  - 采样方式：INA193 以 20 V/V 固定增益检测分流电阻两端压降，输出送入模拟板 ADC（通过 `VDDA` 和相关信号网络）。
  - 典型参数（来自器件数据手册及网表属性）：输入失调电压 `Vos ≈ 2 mV`，带宽 500 kHz，工作电源 `VDDA` ≈ 5 V。

### 3.2 问题来源

INA193 系列本质上是带固定增益的电流检测放大器，其输入与输出均非严格意义上的“轨到轨”，主要表现为：

- 输出端在接近地电位时存在一定的饱和余量（output swing to GND），即即便分流电阻两端电压接近 0，输出也无法完全回落到 0 V，而是停留在若干十毫伏附近。
- 输入端存在有限的失调电压 `Vos`。以当前 25 mΩ 的分流电阻计算：
  - 2 mV 的失调等效为约 `I_offset ≈ 2 mV / 25 mΩ ≈ 80 mA`。
  - 实际失调随温度与个体差异可能更大（数据手册给出了最大值规格）。

在 v4.1 的电流量程设定下（分流电阻较小、目标支持较大电流），上述两个因素叠加会导致：

- 当真实负载电流接近 0 A 时，INA193 输出仍保持在一个非零电压（由输出下限和 `Vos` 共同决定）。
- ADC 端看到的电压—电流曲线在低电流段出现“台阶”或明显非线性，无法通过简单线性标定完全修正。
- 在几十到几百毫安的电流范围内，相对误差可能达到甚至超过数十个百分点，不满足精细测量需求。

### 3.3 v4.2 设计方向与约束

在 v4.2 中，需要根据负载硬件的目标量程与精度要求，对电流检测架构进行调整，避免继续沿用非轨到轨放大器带来的低电流失真。可考虑的方向包括（需要在详细器件选型阶段进一步权衡）：

- 更换为具备轨到轨输出、适合低侧或高侧检测的电流检测放大器，例如同类的低偏置、Rail‑to‑Rail 输出器件（如 INA180/INA181 系列等），并确认：
  - 输出下限在满温满压下仍能压到足够接近 0 V，使 ADC 在低电流段保留有效动态范围。
  - 输入失调电压与增益误差在当前 25 mΩ 分流电阻与目标量程下带来的等效电流误差可接受。
- 若继续使用高侧检测方案但对低电流精度要求较高，可以：
  - 适度增大分流电阻值，以提高低电流段的压降（需评估功耗与压降对系统的影响）。
  - 在固件中增加多点标定曲线，对低端偏差进行补偿，但应视为辅助手段，而非对硬件缺陷的根本修复。
- 重新审视测量需求：
  - 明确 v4.2 设计需要保证“线性 + 可标定”的电流范围（例如 0.1 A 起），并在器件与分流电阻选型时以此为约束。

### 3.4 验证与标定建议

- 在 v4.2 设计阶段，针对新器件/新参数，预先进行纸面计算与 SPICE 仿真，覆盖：
  - 0 A 附近的输出电压下限；
  - 满量程电流时的输出线性度；
  - 全温范围内由 `Vos`、增益误差和输出摆幅限制叠加得到的等效电流误差。
- 在样机阶段，建立标准测试流程：
  - 使用精密电子负载或校准电阻，在 0 A 附近和低电流段（例如 0–1 A）多点采样，记录 ADC 读数与实际电流的对应关系。
  - 给出推荐的固件标定模型（线性或分段线性），并评估是否满足目标精度。

---

后续若 v4.2 在隔离电源拓扑或电流检测架构上引入新的器件或重大改动，应在本文件中追加对应的小节，保持“问题来源 → 设计决策 → 验证方案”的结构一致性，便于未来追踪与回溯。

